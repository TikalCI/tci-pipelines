pipeline
{
    agent any
    stages
    {
        stage('Explore bug')
        {
            steps
            {
                script
                {
                    maxIndex=4
                    def loopers = [:]
                    for (int loopIndex = 0; loopIndex < maxIndex; loopIndex++)
                    {
                        stage("loop-${loopIndex}")
                        {
                            loopers["loop-${loopIndex}"] =
                            {
                                echo "loopIndex=${loopIndex}"
                            }
                        }
                    }
                    parallel loopers
                }
            }
        }
        stage('Bug workaround')
        {
            steps
            {
                script
                {
                    maxIndex=4
                    def loopers = [:]
                    for (int loopIndex = 0; loopIndex < maxIndex; loopIndex++)
                    {
                        index=loopIndex
                        stage("loop-${index}")
                        {
                            loopers["loop-${index}"] =
                            {
                                echo "index=${index}"
                            }
                        }
                    }
                    parallel loopers
                }
            }
        }
    }
}
