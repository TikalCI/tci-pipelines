pipeline
{
    agent any
    stages
    {
        stage('Explore bug')
        {
            steps
            {
                script
                {
                    maxIndex1=3
                    def loopers1 = [:]
                    for (int loopIndex1 = 0; loopIndex1 < maxIndex1; loopIndex1++)
                    {
                        stage("loop-${loopIndex1}")
                        {
                            loopers["loop-${loopIndex1}"] =
                            {
                                echo "loopIndex1=${loopIndex1}"
                            }
                        }
                    }
                    parallel loopers1
                }
            }
        }
        stage('Bug workaround')
        {
            steps
            {
                script
                {
                    maxIndex2=3
                    def loopers2 = [:]
                    for (int loopIndex2 = 0; loopIndex2 < maxIndex2; loopIndex2++)
                    {
                        index2=loopIndex2
                        stage("loop-${index2}")
                        {
                            loopers["loop-${index2}"] =
                            {
                                echo "index2=${index2}"
                            }
                        }
                    }
                    parallel loopers2
                }
            }
        }
    }
}
